<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller = function($scope, spUtil) {
    var c = this;

    // Initialize data.items and currency array
    c.data.items = c.data.items || [];
    c.data.currencyArray = [
        { currency_type: 'USD', selected: false },
        { currency_type: 'EUR', selected: false },
        { currency_type: 'GBP', selected: false },
        { currency_type: 'JPY', selected: false }
    ];

    // Initialize price range
    c.minPrice = 0;
    c.maxPrice = 10000;

    // Function to calculate days left
    c.calculateDaysLeft = function(endDate) {
        if (!endDate) {
            return 'N/A';
        }

        var endDateTime = new Date(endDate);
        var currentDateTime = new Date();
        var timeDiff = endDateTime.getTime() - currentDateTime.getTime();
        var daysLeft = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

        if (daysLeft === 0) {
            return 'Ending today';
        } else if (daysLeft === 1) {
            return 'Ending tomorrow';
        } else {
            return 'Ending in ' + daysLeft + ' days';
        }
    };

    // Function to handle placing a bid
    c.placeBid = function(item) {
        alert('Placing bid for: ' + item.item_name);
        
        spUtil.get('cb_bid_form', { itemSysId: item.sys_id }).then(function(response) {
            spUtil.addInfoMessage('Opening bid form...');
            spUtil.openWidget(response.data);
        });
    };

    // Function to show item details
    c.showDetails = function(item) {
        var itemDetailUrl = "?id=item_details&sys_id=" + item.sys_id;
        window.location.href = itemDetailUrl;
    };

    // Watch the items array for changes
    $scope.$watch(function() {
        return c.data.items;
    }, function(newVal) {
        if (newVal && newVal.length === 0) {
            $scope.noItemsMessage = "No items available";
        } else {
            $scope.noItemsMessage = "";
        }
    }, true);

    // Function to filter items based on the selected categories, search query, and price range
    c.filterItems = function() {
        var selectedCategories = c.data.categoryArray.filter(category => category.selected).map(category => category.sys_id);
        var selectedCurrencies = c.data.currencyArray.filter(currency => currency.selected).map(currency => currency.currency_type);
        var params = {
            selectedCategories: selectedCategories.join(','),
            selectedCurrencies: selectedCurrencies.join(','),
            searchQuery: c.searchQuery || "",
            minPrice: c.minPrice,
            maxPrice: c.maxPrice
        };

        spUtil.get('cb_item_categories', params).then(function(response) {
            c.data.items = response.data.items;
            console.log('Items updated successfully:', response);
        }).catch(function(error) {
            console.error('Error updating items:', error);
        });
    };

    // Initial data fetch
    // c.filterItems();
};
]]></client_script>
        <controller_as>c</controller_as>
        <css>.price-range {
    margin-top: 20px;
}

.price-range label {
    display: block;
    margin-bottom: 5px;
}

.price-range input[type="range"] {
    width: 100%;
    -webkit-appearance: none;
    background: #ddd;
    height: 5px;
    outline: none;
    opacity: 0.7;
    transition: opacity .15s ease-in-out;
}

.price-range input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: #007bff;
    cursor: pointer;
}

.price-range input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: #007bff;
    cursor: pointer;
}

.multiselect .options-container {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ddd;
    padding: 10px;
    background-color: #fff;
}

.multiselect .option {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
}

.multiselect .option input {
    margin-right: 10px;
}
</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>testing_item_multiselect</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>testing item multiselect</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function(input, data, options, gs) {

    data.items = [];
    data.categoryArray = [];

    // Fetch all categories
    var categoryList = new GlideRecord('x_1383184_charityb_category');
    categoryList.query();
    while (categoryList.next()) {
        var catObj = {
            category: categoryList.getValue('category'),
            sys_id: categoryList.getUniqueValue(),
            selected: false
        };
        data.categoryArray.push(catObj);
    }

    input = input || {};
    if (input.selectedCategories || input.selectedCurrencies || input.searchQuery || input.minPrice || input.maxPrice) {
        var selectedCategories = input.selectedCategories ? input.selectedCategories.split(',') : [];
        var selectedCurrencies = input.selectedCurrencies ? input.selectedCurrencies.split(',') : [];
        var searchQuery = input.searchQuery ? input.searchQuery : "";
        var minPrice = input.minPrice ? parseFloat(input.minPrice) : 0;
        var maxPrice = input.maxPrice ? parseFloat(input.maxPrice) : Number.MAX_SAFE_INTEGER;

        var itemGR = new GlideRecord('x_1383184_charityb_item');
        
        if (selectedCategories.length > 0) {
            itemGR.addQuery('category', 'IN', selectedCategories);
        }
        
        if (selectedCurrencies.length > 0) {
            itemGR.addQuery('currency_type', 'IN', selectedCurrencies);
        }
        
        if (searchQuery) {
            itemGR.addQuery('item_name', 'CONTAINS', searchQuery);
        }
        
        itemGR.addQuery('highest_bid_amount', '>=', minPrice);
        itemGR.addQuery('highest_bid_amount', '<=', maxPrice);
        
        itemGR.query();

        while (itemGR.next()) {
            var itemObj = {
                item_name: itemGR.getValue('item_name'),
                sys_id: itemGR.getUniqueValue(),
                highest_bid_amount: itemGR.getValue('highest_bid_amount'),
                value: itemGR.getValue('value'),
                currency: itemGR.getValue('currency_type'),
                auction_status: itemGR.getValue('auction_status'),
                start_bid_amount: itemGR.getValue('start_bid_amount'),
                end_date: itemGR.getValue('end_date'),
                image: itemGR.getDisplayValue('image')
            };
            data.items.push(itemObj);
        }
    }

})(input, data, options, gs);
]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>lalitha</sys_created_by>
        <sys_created_on>2024-06-26 04:36:43</sys_created_on>
        <sys_id>185dff099303021094e3f15a7bba105c</sys_id>
        <sys_mod_count>68</sys_mod_count>
        <sys_name>testing item multiselect</sys_name>
        <sys_package display_value="CharityBids" source="x_1383184_charityb">bcaeeadb9369421094e3f15a7bba1090</sys_package>
        <sys_policy/>
        <sys_scope display_value="CharityBids">bcaeeadb9369421094e3f15a7bba1090</sys_scope>
        <sys_update_name>sp_widget_185dff099303021094e3f15a7bba105c</sys_update_name>
        <sys_updated_by>lalitha</sys_updated_by>
        <sys_updated_on>2024-07-22 10:52:04</sys_updated_on>
        <template><![CDATA[<div class="container">
    <h1>Exclusive Auctions</h1>
    <div class="cont">
        <div class="category">
            <h2>Select Category</h2>
            <div class="multiselect">
                <div class="options-container">
                    <label ng-repeat="category in c.data.categoryArray" class="option">
                        <input type="checkbox" ng-model="category.selected" ng-change="c.filterItems()">
                        <span>{{ category.category }}</span>
                    </label>
                </div>
            </div>
            <h2>Select Currency</h2>
            <div class="multiselect">
                <div class="options-container">
                    <label ng-repeat="currency in c.data.currencyArray" class="option">
                        <input type="checkbox" ng-model="currency.selected" ng-change="c.filterItems()">
                        <span>{{ currency.currency_type }}</span>
                    </label>
                </div>
            </div>
            <h2>Select Price Range</h2>
            <div class="price-range">
                <label for="minPrice">Min Price: {{c.minCurrency}}{{c.minPrice}}</label>
                <input type="range" id="minPrice" ng-model="c.minPrice" ng-change="c.filterItems()" min="0" max="10000" step="100">
                <label for="maxPrice">Max Price: {{c.maxCurrency}}{{c.maxPrice}}</label>
                <input type="range" id="maxPrice" ng-model="c.maxPrice" ng-change="c.filterItems()" min="0" max="10000" step="100">
            </div>
        </div>
        <div class="container1">
            <div class="search-bar">
                <input type="text" ng-model="c.searchQuery" placeholder="Search by item name" ng-change="c.filterItems()">
            </div>
            <div id="items-grid" class="items-grid">
                <div ng-repeat="item in c.data.items" class="item-card" ng-click="c.showDetails(item)">
                    <img ng-src="{{item.image || 'https://dev203498.service-now.com/issues.png'}}" alt="{{item.item_name}}">
                    <div class="item-details">
                        <div class="item-title">{{item.item_name}}</div>
                        <div class="item-value">Value: {{item.currency}}{{item.value}}</div>
                        <div class="item-value">Highest Bid: {{item.currency}}{{item.highest_bid_amount}}</div>
                        <div ng-if="item.auction_status === 'Auction Scheduled'" class="item-start-bid">Start Bid: {{item.start_bid_amount}}</div>
                        <div class="item-days-left">
                            <span class="days-left-indicator"
                                  ng-class="{'days-left-orange': c.calculateDaysLeft(item.end_date) !== 'Ended'}">
                                {{ c.calculateDaysLeft(item.end_date) === '2' ? '2 days left' : c.calculateDaysLeft(item.end_date) }}
                            </span>
                        </div>
                        <button ng-if="item.auction_status === 'Auction In Progress'" class="btn btn-secondary" ng-click="c.placeBid(item)">Place Bid</button>
                    </div>
                </div>
            </div>
            <div ng-if="c.data.noItemsMessage">
                {{ c.data.noItemsMessage }}
            </div>
        </div>
    </div>
</div>
]]></template>
    </sp_widget>
</record_update>
